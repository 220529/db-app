# DB App 数据库架构说明

## 角色定位

db-app 是 ERP 系统的**基础设施层**，提供：
- MySQL 数据库
- Redis 缓存
- 共享 Docker 网络 (`erp-db-network`)

## 架构图

```
        ┌─────────────────┐     ┌─────────────────┐
        │   erp-core      │     │    erp-web      │
        │   (后端 API)     │     │    (前端)       │
        └─────────────────┘     └─────────────────┘
                  │                      │
                  └──────────┬───────────┘
                             │
                    erp-db-network
                             │
              ┌──────────────┴──────────────┐
              ▼                             ▼
     ┌─────────────────┐           ┌─────────────────┐
     │   erp-mysql     │           │   erp-redis     │
     │   (端口 3306)    │           │   (端口 6379)    │
     └─────────────────┘           └─────────────────┘
              │                             │
              ▼                             ▼
        mysql_data                    redis_data
        (数据卷)                       (数据卷)
```

## 网络配置

本服务创建 `erp-db-network` 网络，其他服务通过加入此网络来访问数据库。

```yaml
networks:
  erp-network:
    driver: bridge
    name: erp-db-network   # 这是关键！
```

**重要**：本服务必须最先启动，否则其他服务无法加入网络。

## 服务配置

### MySQL

| 配置项 | 值 |
|--------|-----|
| 版本 | 8.0 |
| 端口 | 3306 |
| 字符集 | utf8mb4 |
| 最大连接数 | 500 |
| 缓冲池 | 1G |

### Redis

| 配置项 | 值 |
|--------|-----|
| 版本 | 7 (Alpine) |
| 端口 | 6379 |
| 持久化 | AOF |
| 最大内存 | 512MB |
| 淘汰策略 | allkeys-lru |

## 数据持久化

| 数据卷 | 用途 |
|--------|------|
| `mysql_data` | MySQL 数据文件 |
| `redis_data` | Redis AOF 文件 |
| `./backups` | MySQL 备份目录 |

## 文件结构

```
db-app/
├── docker-compose.prod.yml   # 生产环境配置
├── .env.prod                 # 环境变量 (密码等)
├── mysql/
│   ├── conf.d/               # MySQL 配置文件
│   └── init/                 # 初始化 SQL 脚本
├── backups/                  # 备份目录
└── ARCHITECTURE.md           # 本文档
```

## 环境变量 (.env.prod)

```bash
# MySQL
MYSQL_ROOT_PASSWORD=your_strong_password

# Redis
REDIS_PASSWORD=your_redis_password
```

## 健康检查

### MySQL
```yaml
healthcheck:
  test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
  interval: 10s
  timeout: 5s
```

### Redis
```yaml
healthcheck:
  test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
  interval: 10s
  timeout: 5s
```

## 部署命令

```bash
cd /app/db-app

# 启动服务
docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

# 查看状态
docker compose -f docker-compose.prod.yml ps

# 查看日志
docker compose -f docker-compose.prod.yml logs -f
```

## 数据库初始化

`mysql/init/` 目录下的 SQL 脚本会在首次启动时自动执行，用于：
- 创建 `erp_core` 数据库
- 创建 `erp_user` 用户并授权

## 备份与恢复

### 备份

```bash
docker exec erp-mysql mysqldump -u root -p erp_core > backups/erp_core_$(date +%Y%m%d).sql
```

### 恢复

```bash
docker exec -i erp-mysql mysql -u root -p erp_core < backups/erp_core_20241126.sql
```

## 依赖关系

本服务是最底层服务，不依赖其他服务。

**部署顺序**：`db-app` (本服务) → `erp-core` → `erp-web` → `nginx-app`
